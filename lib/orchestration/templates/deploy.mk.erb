compose_base:=HOST_UID=$(shell id -u) \
              DOCKER_USERNAME=%%USERNAME%% \
              DOCKER_REPOSITORY=%%REPOSITORY%%:%%VERSION%% \
              docker-compose \
              -p %%REPOSITORY%% \
              -f docker-compose.yml

compose:=${compose_base} -f docker-compose.production.yml -f docker-compose.override.yml

.PHONY: deploy
deploy:
	@echo "Deploying application to Docker swarm..."
	@${compose} config | docker stack deploy -c - %%REPOSITORY%%

.PHONY: deploy
stop:
	@echo "Stopping containers..."
	@${compose} down

.PHONY: deploy
start:
	@echo "Launching application..."
	@${compose} up -d --scale app=$${instances:-1}

.PHONY: deploy
config:
	@${compose} config

.PHONY: deploy
pull:
	@${compose} pull

.PHONY: deploy
logs:
	@${compose} logs -f

.PHONY: deploy
migrate:
	@${compose} run --rm app bundle exec rake db:migrate

.PHONY: compose
compose:
	@echo ${compose}
