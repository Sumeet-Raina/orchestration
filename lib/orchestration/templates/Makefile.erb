.PHONY: start stop migrate bundle docker build push start logs compose config <%= wait_commands.join(' ') %>

### Environment setup ###

DOCKER_USERNAME:=$(shell bash ./<%= env.orchestration_dir_name %>/yaml.bash docker_username)
DOCKER_REPOSITORY:=$(shell bash ./<%= env.orchestration_dir_name %>/yaml.bash docker_repository)

COMPOSE_BASE:=HOST_UID=$(shell id -u) \
              DOCKER_USERNAME=${DOCKER_USERNAME} \
              DOCKER_REPOSITORY=${DOCKER_REPOSITORY} \
              docker-compose \
              -p ${DOCKER_REPOSITORY} \
              -f <%= env.orchestration_dir_name %>/docker-compose.yml

GIT_BRANCH:=$(if $(BRANCH),$(BRANCH),$(shell git rev-parse --abbrev-ref HEAD))
GIT_VERSION:=$(shell git rev-parse --short --verify ${GIT_BRANCH})

-include .env
export

ifneq (,$(RAILS_ENV))
  ENV:=$(RAILS_ENV)
else ifneq (,$(RACK_ENV))
  ENV:=$(RACK_ENV)
else
  ENV:=development
endif

COMPOSE:=${COMPOSE_BASE} -f <%= env.orchestration_dir_name %>/docker-compose.${ENV}.yml -f <%= env.orchestration_dir_name %>/docker-compose.override.yml
RAKE:=RACK_ENV=${ENV} RAILS_ENV=${ENV} bin/rake

### Container management commands ###

start:
	@echo "Starting containers..."
ifeq (${ENV},$(filter ${ENV},test development))
	@${COMPOSE} up -d
else
	@${COMPOSE} up -d --scale app=$${INSTANCES:-1}
endif
	@make wait

stop:
	@echo "Stopping containers..."
	@${COMPOSE} down
	@echo "All containers stopped."

logs:
	@${COMPOSE} logs

config:
	@${COMPOSE} config

compose:
	@${COMPOSE} $$cmd

### Deployment utility commands ###

bundle:
	@echo 'Building deployment bundle...'
	@rm -rf <%= env.orchestration_dir_name %>/.deploy/
	@mkdir -p <%= env.orchestration_dir_name %>/.deploy/${DOCKER_REPOSITORY}/
	@sed -e "s/%%VERSION%%/${GIT_VERSION}/g" \
             -e "s/%%REPOSITORY%%/${DOCKER_REPOSITORY}/g" \
             -e "s/%%USERNAME%%/${DOCKER_USERNAME}/g" \
             <%= env.orchestration_dir_name %>/deploy.mk > \
             <%= env.orchestration_dir_name %>/.deploy/${DOCKER_REPOSITORY}/Makefile
	@cp <%= env.orchestration_dir_name %>/docker-compose.yml \
            <%= env.orchestration_dir_name %>/docker-compose.production.yml \
            <%= env.orchestration_dir_name %>/docker-compose.override.yml \
            <%= env.orchestration_dir_name %>/.deploy/${DOCKER_REPOSITORY}/
	@tar -C <%= env.orchestration_dir_name %>/.deploy -cf ./orchestration.tar ./${DOCKER_REPOSITORY}
	@echo 'Deployment bundle written to ./orchestration.tar'

### Database utility commands ###

migrate:
	@echo "Running migrations..."
ifeq (${ENV},$(filter ${ENV},test development))
	@${RAKE} db:migrate
else
	@${COMPOSE} run --rm app bin/rake db:migrate RAILS_ENV=${ENV}
endif
	@echo "Migrations complete."

### Service healthcheck commands ###

wait: <%= wait_commands.join(' ') %>
	@echo "All Containers ready."

## Test/development wait commands

wait-database:
ifeq (${ENV},$(filter ${ENV},test development))
	@${RAKE} orchestration:database:wait
endif

wait-mongo:
ifeq (${ENV},$(filter ${ENV},test development))
	@${RAKE} orchestration:mongo:wait
endif

wait-rabbitmq:
ifeq (${ENV},$(filter ${ENV},test development))
	@${RAKE} orchestration:rabbitmq:wait
endif

## Production wait commands

wait-nginx_proxy:
ifneq (${ENV},$(filter ${ENV},test development))
	@${RAKE} orchestration:nginx_proxy:wait LISTEN_PORT=${LISTEN_PORT}
endif

wait-app:
ifneq (${ENV},$(filter ${ENV},test development))
	@${RAKE} orchestration:app:wait LISTEN_PORT=${LISTEN_PORT}
endif

### Docker build commands ###

docker: build push

build:
	@echo "Preparing build from ${GIT_BRANCH}"
	@mkdir -p ./<%= env.orchestration_dir_name %>/.build
	@git show ${GIT_BRANCH}:./Gemfile > ./<%= env.orchestration_dir_name %>/.build/Gemfile
	@git show ${GIT_BRANCH}:./Gemfile.lock > ./<%= env.orchestration_dir_name %>/.build/Gemfile.lock
	<% if defined?(Webpacker) %>@git show ${GIT_BRANCH}:./package.json > ./<%= env.orchestration_dir_name %>/.build/package.json<% end %>
	<% if defined?(Webpacker) %>@git show ${GIT_BRANCH}:./yarn.lock > ./<%= env.orchestration_dir_name %>/.build/yarn.lock<% end %>
	@echo "Building..."
	@git archive --format tar.gz -o ./<%= env.orchestration_dir_name %>/.build/context.tar.gz ${GIT_BRANCH}
	@docker build \
	             --build-arg BUNDLE_GITHUB__COM \
	             --build-arg BUNDLE_BITBUCKET__ORG \
		     -t ${DOCKER_USERNAME}/${DOCKER_REPOSITORY} \
		     -t ${DOCKER_USERNAME}/${DOCKER_REPOSITORY}:${GIT_VERSION} \
		     ./<%= env.orchestration_dir_name %>/
	@echo "Build complete."

push:
	docker push ${DOCKER_USERNAME}/${DOCKER_REPOSITORY}:${GIT_VERSION}
